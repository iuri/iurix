***************
*** 11,16 ****
      {upload_file:optional,trim ""}
      upload_file.tmpfile:optional,tmpfile
      album_id:integer,notnull
  } -validate {
      valid_album -requires {album_id:integer} {
  	if [string equal [pa_is_album_p $album_id] "f"] {
--- 11,17 ----
      {upload_file:optional,trim ""}
      upload_file.tmpfile:optional,tmpfile
      album_id:integer,notnull
+     return_url:optional
  } -validate {
      valid_album -requires {album_id:integer} {
  	if [string equal [pa_is_album_p $album_id] "f"] {
***************
*** 37,54 ****
       [ catch {set tmp_dir [pa_expand_archive $upload_file ${upload_file.tmpfile} pa-$album_id] } errMsg] } { 
      ad_return_complaint 1 "Unable to expand your archive file"
      ad_script_abort
- } 
  
  ReturnHeaders text/html
  ns_write "<html><head><title>Upload Log</title></head><body><h1>Upload Log</h1><hr>\n"
  
  if {![empty_string_p $upload_file]} { 
-     ns_write "starting to load images from file $upload_file<br>\n"
      ns_log Debug "made directory $tmp_dir to extract from ${upload_file.tmpfile} ($upload_file)\n"
      set allfiles [pa_walk $tmp_dir]
      set remove 1
  } else { 
-     ns_write "starting to load images from directory [parameter::get -parameter FullTempPhotoDir -package_id [ad_conn package_id]]<br>\n"
      set allfiles [pa_walk [parameter::get -parameter FullTempPhotoDir -package_id [ad_conn package_id]]]
      set remove 0
  }     
--- 38,61 ----
       [ catch {set tmp_dir [pa_expand_archive $upload_file ${upload_file.tmpfile} pa-$album_id] } errMsg] } { 
      ad_return_complaint 1 "Unable to expand your archive file"
      ad_script_abort
+ }
  
+ if { ![exists_and_not_null return_url] } {
  ReturnHeaders text/html
  ns_write "<html><head><title>Upload Log</title></head><body><h1>Upload Log</h1><hr>\n"
+ }
  
  if {![empty_string_p $upload_file]} { 
+     if { ![exists_and_not_null return_url] } {
+         ns_write "starting to load images from file $upload_file<br>\n"
+     }
      ns_log Debug "made directory $tmp_dir to extract from ${upload_file.tmpfile} ($upload_file)\n"
      set allfiles [pa_walk $tmp_dir]
      set remove 1
  } else { 
+     if { ![exists_and_not_null return_url] } {
+         ns_write "starting to load images from directory [parameter::get -parameter FullTempPhotoDir -package_id [ad_conn package_id]]<br>\n"
+     }
      set allfiles [pa_walk [parameter::get -parameter FullTempPhotoDir -package_id [ad_conn package_id]]]
      set remove 0
  }     
***************
*** 58,67 ****
  pa_flush_photo_in_album_cache $album_id 
  
  set page [pa_page_of_photo_in_album [lindex $new_photo_ids 0] $album_id]
  ns_write "<a href=\"album?album_id=$album_id&page=$page\">View the images</a>"
  ns_write "</body></html>"
  
  # Now that we are done working on the upload we delete the tmp file
  if [info exists tmp_dir] { 
      file delete -force $tmp_dir
  }
--- 65,83 ----
  pa_flush_photo_in_album_cache $album_id 
  
  set page [pa_page_of_photo_in_album [lindex $new_photo_ids 0] $album_id]
+ 
+ if { ![exists_and_not_null return_url] } {
  ns_write "<a href=\"album?album_id=$album_id&page=$page\">View the images</a>"
  ns_write "</body></html>"
+ }
  
  # Now that we are done working on the upload we delete the tmp file
  if [info exists tmp_dir] { 
      file delete -force $tmp_dir
  }
+ 
+ # HAM : added return_url
+ if { [exists_and_not_null return_url] } {
+     ad_returnredirect $return_url
+     ad_script_abort
+ }
